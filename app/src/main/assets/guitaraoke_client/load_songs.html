<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Guitaraoke Load Songs</title>
    <meta http-equiv="Content-type" content="text/html" />
    <meta name="Description" content="Guitaraoke Load Songs">
    <meta name="author" content="https://github.com/LucianoBestia/guitaraoke_client">

    <meta name="viewport" content="width = device-width,initial-scale = 1.0" />
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/guitaraoke_client.css">
    <meta name="google" content="notranslate">
</head>

<body>
    <div class="fixed_header" style="height: 8vh;width: var(--body_width)">
        <div id="div_header" style="display: grid;width: var(--body_width);grid-template-columns: 100% ; grid-template-rows: 10vh;">
            <div id="div_header_title">Guitaraoke Load Songs</div>
        </div>
    </div>
    <div style="position: absolute;top:10vh;height: 93vh; ;width: var(--body_width);align-items: center; text-align: center; ">
        <p></p>
        <label for="songs_urls" style="display:block;">copy-paste the songs urls (one url per line):</label>
        <textarea id="songs_urls" rows="5" style="display:block;width: 100%;"></textarea>
        <p></p>
        <button onclick="download_song();">Start download</button>
        <p></p>
        <div id="div_msg_for_user" style="color: red;"></div>
        <p></p>
        <div>The songs will be downloaded in the background.</div>
        <div>It will take a minute or so.</div>
        <p></p>
        <a href="leader.html">
            <Button>Back to  Guitaraoke Leader page</Button>
        </a>
    </div>

    <script>
        // region: this is executed directly after html load

        // endregion: this is executed directly after html load

        function download_song() {
            console.log("download_song");
            let songs_urls = document.getElementById("songs_urls").value;
            let div_msg_for_user = document.getElementById("div_msg_for_user");
            // there can be more songs delimited with \n "ne line"
            // the android download manager will take care to download multiple songs one by one
            let splitted = songs_urls.split("\n");
            let text_for_div_msg_for_user = "";
            for (let i = 0; i < splitted.length; i++) {
                let song_url = splitted[i];
                let splitted_song_name = song_url.split("/");
                let song_name = splitted_song_name[splitted_song_name.length - 1];
                song_name = decodeURI(song_name);

                if (!song_url.endsWith(" - guitaraoke.mp4") && !song_url.endsWith("%20-%20guitaraoke.mp4") && !song_url.endsWith(" - guitaraoke.mp4?dl=1") && !song_url.endsWith("%20-%20guitaraoke.mp4?dl=1")) {
                    text_for_div_msg_for_user.append += "The song_url does not end with ' - guitaraoke.mp4' or ' - guitaraoke.mp4?dl=1' :" + "\n" + song_name + "\n\n";
                } else if (!song_url.startsWith("http://") && !song_url.startsWith("https://")) {
                    div_msg_for_user.innerText = "The song_url does not start with 'http://' or 'https://' : " + "\n" + song_name + "\n\n";
                } else {
                    if (window.XMLHttpRequest) {
                        let http_request = new XMLHttpRequest();
                        let page_url = "download_song.html";

                        let params = "song_url=" + encodeURIComponent(song_url);
                        http_request.open("POST", page_url, true);

                        //Send the proper header information along with the request
                        http_request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                        http_request.onreadystatechange = function() { //Call a function when the state changes.
                            if (http_request.readyState == 4 && http_request.status == 200) {
                                console.log(http_request.responseText);
                            }
                        }
                        http_request.send(params);
                    }
                }
            }
        }
    </script>
</body>

</html>