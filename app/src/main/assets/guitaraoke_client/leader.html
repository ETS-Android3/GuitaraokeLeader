<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <title>Guitaraoke Leader</title>
    <meta http-equiv="Content-type" content="text/html" />
    <meta name="Description" content="Guitaraoke Leader"/>
    <meta name="author" content="https://github.com/LucianoBestia/guitaraoke_client"/>

    <meta name="viewport" content="width = device-width,initial-scale = 1.0" />
    <link rel="stylesheet" href="css/normalize.css"/>
    <link rel="stylesheet" href="css/guitaraoke_client.css"/>
    <script src="js/common.js" ></script>
    <meta name="google" content="notranslate"/>
</head>

<body>
    <div class="fixed_header" style="height: 8vh;width: var(--body_width)">
        <div id="div_header" style="display: grid;width: var(--body_width);grid-template-columns: 100% ; grid-template-rows: 10vh;">
            <div id="div_header_title">Guitaraoke Leader</div>
        </div>
    </div>

    <div style="position: absolute;top:10vh;height: 93vh; ;width: var(--body_width);align-items: center; text-align: center; ">
        <p></p>
        <div id="div_rotate" style="color: red;">Please rotate the device to landscape mode!</div>
        <div id="div_start" style=" align-items: center; text-align: center;">
            <!--list_of_files_in_folder_videos-->
            <p></p>
            <a href="load_songs.html">
                <button>Download new songs</button>
            </a>
            <p></p>
            <div>
                <button id="button_bye" onclick="send_message('bye!');">Bye</button>
            </div>
           
        </div>
        <div id="div_play_video" >
            <div>
                <button id="back_to_list" onclick="send_message('stop!');">Back to song list</button>
            </div>
            <p></p>
            <div id="div_song_name">song_name</div>  
            <p></p>          
            <div>
                <button id="send_play" onclick="send_message('play!');">Play</button>
            </div>
            <div>
                <button id="send_pause" onclick="send_message('stop!');">Stop</button>
                <p></p>
            </div>
            <div>
                <button id="button_fullscreen" onclick="video_video.requestFullscreen();">FullScreen</button>
                <video id="video_video" height="1" width="100%"><source type="video/mp4"></video>
            </div>            
        </div>
    </div>
    <script>
        "use strict";
        // region: this is executed directly after html load

        // this web page can be in different states. A state defines which elements are hidden or visible.
        const PageState = {
        SongList: 'SongList',
        SongLoad: 'SongLoad',
        SongPlay: 'SongPlay',
        Bye: 'Bye'
        };        
        var page_state=PageState.SongList;
var websocket;
        var server_client_timestamp_diff=0;
        var ping_server_ms=0;
        var timestamp_before_request=0;
        var video_video = el("video_video");
        var user_name;

        // region: event listeners
        video_video.addEventListener('ended', my_video_ended);
        window.onresize = function(){ warn_user_to_change_orientation(); };
        // endregion: event listeners

        warn_user_to_change_orientation();
        start_sync_clock_with_server();

        state_transition_to_song_list();        
        //connect immediately to server
        connect_to_guitaraoke_server()
        // endregion: this is executed directly after html load

        function connect_to_guitaraoke_server() {
            user_name = getRandomInt(0, 1000000);
            let url = window.location.href;
            console.log(url);
            //TODO: this url is fixed only for developing
            //var ws_url = "ws://192.168.104.232:3000";
            //TODO: this url is needed in runtime
            let ws_url = url.replace("http://","ws://").replace("8080","3000");
            console.log(ws_url);
            websocket = new WebSocket(ws_url);
            websocket.onopen = function(e) {
                console.log("[open] Connection established");
            };

            websocket.onmessage = function(event) {
                let msg = JSON.parse(event.data);
                //console.log(`[message] : ${msg.data}`);
                if (msg.data.startsWith("song: ")) {
                    let song_name = msg.data.substring(6);
                    state_transition_from_song_list_to_song_load(song_name);
                } else if (msg.data == "play!") {
                    state_transition_from_song_load_to_song_play();                    
                } else if (msg.data == "stop!") {
                    state_transition_from_song_play_to_song_list();                    
                } else if (msg.data == "bye!") {
                    state_transition_to_bye();
                } else if (msg.data == "sync_request!") {
                    let leader_sync_clock_with_correction = Date.now()+sync_clock_correction;
                    send_message("sync_reply: "+msg.username+" "+(video_video.currentTime*1000).toString()+" "+ leader_sync_clock_with_correction);                    
                }                
            };

            websocket.onclose = function(event) {
                if (event.wasClean) {
                    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Connection died');
                }
            };

            websocket.onerror = function(error) {
                console.log(`[error] ${error.message}`);
            };
        }

        // region: state UI transormation
        function state_ui_song_list(){
            page_state = PageState.SongList;
            el("div_start").hidden = false;
            el("div_play_video").hidden = true; 
            el("button_fullscreen").hidden = true;
        }

        function state_ui_song_load(){
            page_state = PageState.SongLoad;
            el("div_start").hidden = true;
            el("div_play_video").hidden = false;
            el("back_to_list").hidden = false;
            el("send_play").hidden = false;
            el("send_pause").hidden = true;
        }

        function state_ui_song_play(){
            page_state = PageState.SongPlay;
            el("div_start").hidden = true;
            el("div_play_video").hidden = false;
            el("send_play").hidden = true;
            el("send_pause").hidden = false;
            el("back_to_list").hidden = true;
            el("button_fullscreen").hidden = false;  
        }

        function state_ui_bye(){
            page_state = PageState.Bye;
        }
        // endregion: state UI transormation

        // region: state transition
        function state_transition_to_song_list(){
            state_ui_song_list()                          
        }

        function state_transition_from_song_list_to_song_load(song_name){
            state_ui_song_load();
            song_load(song_name);                    
        }

        function state_transition_from_song_load_to_song_play(){
            state_ui_song_play();            
            video_video.play();
        }

        function state_transition_from_song_play_to_song_list(){
            state_ui_song_list();
            video_video.pause();
            exit_full_screen();            
        }

        function state_transition_to_bye(){
            state_ui_bye();
            exit_full_screen();
            open("bye.html");
        }
        
        // endregion: state transition

        function send_song_name(song_name) {
            send_message("song: " + song_name);
        }

        function my_video_ended() {
            send_message('stop!');
            exit_full_screen();
        }
       
    </script>
</body>

</html>