<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Guitaraoke Follower</title>
    <meta http-equiv="Content-type" content="text/html" />
    <meta name="Description" content="Guitaraoke Follower">
    <meta name="author" content="https://github.com/LucianoBestia/guitaraoke_client">

    <meta name="viewport" content="width = device-width,initial-scale = 1.0" />
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/guitaraoke_client.css">
    <script src="js/common.js" ></script>
    <meta name="google" content="notranslate">
</head>

<body>
    <div class="fixed_header" style="height: 8vh;width: var(--body_width)">
        <div id="div_header" style="display: grid;width: var(--body_width);grid-template-columns: 100% ; grid-template-rows: 10vh;">
            <div id="div_header_title">Guitaraoke Follower</div>
        </div>
    </div>

    <div style="position: absolute;top:10vh;height: 93vh; ;width: var(--body_width);align-items: center; text-align: center; ">
        <p></p>
        <div id=div_rotate style="color: red;">Please rotate the device to landscape mode!</div>
        <div id="div_start" style=" align-items: center; text-align: center;">
            <button id="button_start" onclick="state_change_from_start_to_waiting();">Start user interaction</button>
            <div id="div_waiting" >
                <p>Waiting for leader to select song and start playing...</p>                
                <p></p>
                <div>Some devices are slower to start playing a song. Adjust this delay in milliseconds (from 0 to 999):</div>
                <input id="text_play_delay_ms" type="text" value="000" size="3" maxlength="3" oninput="text_play_delay_ms_on_input();" />
                <p></p>
                <p>Put your phone volume on maximum and change Settings - Display - Screen timeout to 10 minutes.</p>
            </div>                       
        </div>
        <div id="div_play_video" style=" align-items: center; text-align: center;">
            <p></p>
            <div id="div_song_name">song_name</div>      
            <p><button id="button_fullscreen" onclick="video_video.requestFullscreen();">FullScreen</button></p>
            <button id="button_slower" onclick="video_video.playbackRate = video_video.playbackRate-0.005;el('span_speed').innerText='--- speed: '+video_video.playbackRate.toFixed(3)+' ---';">Slower</button>
            <span id="span_speed">--- speed: 1.000 ---</span>
            <button id="button_faster" onclick="video_video.playbackRate = video_video.playbackRate+0.005;el('span_speed').innerText='--- speed: '+video_video.playbackRate.toFixed(3)+' ---';">Faster</button>                
            <p><button id="button_muted_toggle" onclick="button_muted_toggle_on_click();">Mute sound</button></p>
            <div>Sometimes the playback on some devices is not in sync. You can try to change the playback speed to sync them, like an old-school DJ on two vinyl records turntable.</div>
            <div>Or you can simply mute the sound if it is terrible.</div>
            <video id="video_video" preload="auto" height="1" width="100%"><source type="video/mp4"></video>
        </div>
    </div>
    <script>
        // region: this is executed directly after html load

        // this web page can be in different states. A state defines which elements are hidden or visible.
        const PageState = {
        Start: 'Start',
        Waiting: 'Waiting',
        SongLoad: 'SongLoad',
        SongPlay: 'SongPlay',
        Bye: 'Bye'
        };        
        var page_state=PageState.Start;

        // region: dynamic elements        
        var websocket;
        var button_start = el("button_start");
        var div_waiting = el("div_waiting");
        var video_video = el("video_video");
        var div_start = el("div_start");
        var div_play_video = el("div_play_video");
        var div_song_name = el("div_song_name");
        var text_play_delay_ms = el("text_play_delay_ms");        
        var button_fullscreen = el("button_fullscreen");               
        // endregion: dynamic elements     

        // region: event listeners
        window.onresize = function(){ warn_user_to_change_orientation(); };
        // endregion: event listeners

        // from local storage
        var play_delay_ms = window.localStorage.getItem('play_delay_ms'); 
        if (!play_delay_ms){
            play_delay_ms="000";
        }
        text_play_delay_ms.value = play_delay_ms;

        warn_user_to_change_orientation();
        state_change_to_start();
        // endregion: this is executed directly after html load

        function connect_to_guitaraoke_server() {
            user_name = getRandomInt(0, 1000000);
            var url = window.location.href;
            console.log(url);
            //TODO: this url is fixed only for developing
            //var ws_url = "ws://192.168.104.232:3000";
            //TODO: this url is needed in runtime
            var ws_url = url.replace("http://","ws://").replace("8080","3000");
            console.log(ws_url);
            websocket = new WebSocket(ws_url);
            websocket.onopen = function(e) {
                console.log("[open] Connection established");
            };

            websocket.onmessage = function(event) {
                var msg = JSON.parse(event.data);
                //console.log(`[message] : ${msg.data}`);
                if (msg.data.startsWith("song: ")) {
                    var song_name = msg.data.substring(6);
                    state_change_from_waiting_to_song_load(song_name);                   
                } else if (msg.data == "play!") {
                    state_change_from_song_load_to_play();                      
                } else if (msg.data == "stop!") {
                    state_change_from_play_to_waiting();                    
                } else if (msg.data == "bye!") {
                    state_change_to_bye();
                }
            };

            websocket.onclose = function(event) {
                if (event.wasClean) {
                    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Connection died');
                }
            };

            websocket.onerror = function(error) {
                console.log(`[error] ${error.message}`);
            };
        }

        function state_change_to_start(){
            page_state = PageState.Start;
            div_start.hidden = false;
            button_start.hidden = false;
            div_waiting.hidden = true;
            div_play_video.hidden = true;
        }

        function state_change_from_start_to_waiting(){
            page_state = PageState.Waiting;
            connect_to_guitaraoke_server();
            button_start.hidden = true;
            div_waiting.hidden = false;
        }

        function state_change_from_waiting_to_song_load(song_name){
            page_state = PageState.SongLoad;
            song_load(song_name);
            div_start.hidden = true;
            div_play_video.hidden = false;
        }

        function state_change_from_song_load_to_play(){
            var new_delay = 1000 - parseInt(play_delay_ms);
            console.log("new_delay: "+new_delay);
            setTimeout(function(){video_video.play();},new_delay);
            button_fullscreen.hidden = false;
        }

        function state_change_from_play_to_waiting(){
            exit_full_screen();
            video_video.pause();
            div_start.hidden = false;            
            div_waiting.hidden = false;
            div_play_video.hidden = true;
        }

        function state_change_to_bye(){
            exit_full_screen();
            open("bye.html");
        }

        function button_muted_toggle_on_click() {
            if (video_video.muted == true) {
                video_video.muted = false;
                el("button_muted_toggle").innerText = "Mute sound";
            } else {
                video_video.muted = true;
                el("button_muted_toggle").innerText = "Unmute sound";
            }
        }

        function text_play_delay_ms_on_input(){
            // allow only 3 numbers, remove non-numbers
            var new_string = "";
            for (let i = 0; i < text_play_delay_ms.value.length; i++) {
                if (text_play_delay_ms.value[i]>="0" && text_play_delay_ms.value[i]<="9"){
                    new_string += text_play_delay_ms.value[i];
                }
            }            
            text_play_delay_ms.value = new_string;
            if (text_play_delay_ms.value == ""){
                play_delay_ms="000";
            } else{
                play_delay_ms = text_play_delay_ms.value;
            }
            window.localStorage.setItem('play_delay_ms',play_delay_ms);
        }

    </script>
</body>

</html>