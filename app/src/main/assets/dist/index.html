<!DOCTYPE html>
<html lang="en">

<head>
    <!-- classic header for a web page -->
    <meta charset="utf-8">
    <title>Guitaraoke Follower</title>
    <meta http-equiv="Content-type" content="text/html" />
    <meta name="Description" content="Guitaraoke Follower">
    <meta name="author" content="https://github.com/LucianoBestia/guitaraoke_client">

    <meta name="viewport" content="width = device-width,initial-scale = 1.0" />
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/guitaraoke_client.css">
    <meta name="google" content="notranslate">
</head>

<body>
    <div class="fixed_header" style="height: 7vh;width: var(--body_width)">
        <div id="div_units_header" style="display: grid;width: var(--body_width);grid-template-columns: 100% ; grid-template-rows: 7vh;">
            <div id="div_units_title">Guitaraoke Follower</div>
        </div>
    </div>
    <div style="position: absolute;top:7vh;height: 93vh; ;width: var(--body_width);align-items: center; text-align: center; ">
        <p></p>
        <div id="div_start" style=" align-items: center; text-align: center;">
            <button id="button_start" onclick="start_following();">Start guitaraoke</button>
            <div id="div_waiting" hidden=true>Waiting for leader to select song and start playing...</div>
        </div>
        <div id="div_video" style=" align-items: center; text-align: center;" hidden=true>
            <div id="div_song_name">song_name</div>
            <video id="video_video" height="120" width="100%"><source type="video/mp4"></video>
            <button id="button_fullscreen" onclick="video_video.requestFullscreen();">FullScreen</button>

        </div>
    </div>
    <script>
        // region: this is executed directly after html load
        // region: dynamic elements
        var websocket;
        var button_start = document.getElementById("button_start");
        var div_waiting = document.getElementById("div_waiting");
        var video_video = document.getElementById("video_video");
        var div_start = document.getElementById("div_start");
        var div_video = document.getElementById("div_video");
        var div_song_name = document.getElementById("div_song_name");
        // endregion: dynamic elements
        // region: event listeners
        //video_video.addEventListener('ended', my_video_ended);
        window.onbeforeunload = function() {
            console.log("window.onbeforeunload");
            //websocket.onclose = function() {}; // disable onclose handler first
            websocket.close();
        };
        window.onunload = function() {
            console.log("window.onunload");
            //websocket.onclose = function() {}; // disable onclose handler first
            websocket.close();
        };
        // endregion: event listeners

        // endregion: this is executed directly after html load

        function connect_to_guitaraoke_server() {
            user_name = getRandomInt(0, 1000000);
            var url = window.location.href;
            console.log(url);
            //TODO: this url is fixed only for developing
            var ws_url = "ws://192.168.104.232:3000";
            //TODO: this url is needed in runtime
            //var ws_url = url.replace("http://","ws://").replace("8080","3000");
            console.log(ws_url);
            websocket = new WebSocket(ws_url);
            websocket.onopen = function(e) {
                console.log("[open] Connection established");
                console.log("Sending to server");
            };

            websocket.onmessage = function(event) {
                var msg = JSON.parse(event.data);
                console.log(`[message] Data received from server: ${msg}`);
                if (msg.data.startsWith("song: ")) {
                    load_song(msg.data.substring(6))
                } else if (msg.data == "play!") {
                    video_video.play();
                    document.getElementById("button_fullscreen").hidden = false;
                } else if (msg.data == "pause!") {
                    video_video.pause();
                    document.getElementById("button_fullscreen").hidden = true;
                } else if (msg.data == "bye!") {
                    if (document.fullscreenElement) {
                        document.exitFullscreen()
                            .then(() => console.log("Document Exited from Full screen mode"))
                            .catch((err) => console.error(err))
                    }
                    document.getElementById("button_fullscreen").hidden = true;
                }
            };

            websocket.onclose = function(event) {
                if (event.wasClean) {
                    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Connection died');
                }
            };

            websocket.onerror = function(error) {
                console.log(`[error] ${error.message}`);
            };
        }

        function start_following() {
            connect_to_guitaraoke_server();
            button_start.hidden = true;
            div_waiting.hidden = false;
        }

        function load_song(song_name) {
            console.log("load_song");
            div_start.hidden = true;
            div_video.hidden = false;
            div_song_name.innerText = song_name;
            video_video.src = "videos/" + song_name + " - guitaraoke.mp4";
            video_video.load();
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>
</body>

</html>